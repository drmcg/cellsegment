---

title: Data preparation utilities
keywords: fastai
sidebar: home_sidebar

summary: "Functions that prepare label files and split the data into train validation and test sets"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/01_dataprep_utils.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
    
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="__label_colormap" class="doc_header"><code>__label_colormap</code><a href="https://github.com/johnnewto/cellsegment/tree/master/cellsegment/dataprep.py#L37" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>__label_colormap</code>(<strong><code>N</code></strong>=<em><code>256</code></em>)</p>
</blockquote>
<p>create a colour map for the segmentation labels</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="createjson" class="doc_header"><code>createjson</code><a href="https://github.com/johnnewto/cellsegment/tree/master/cellsegment/dataprep.py#L61" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>createjson</code>(<strong><code>fn</code></strong>=<em><code>''</code></em>, <strong><code>offset</code></strong>=<em><code>0</code></em>)</p>
</blockquote>
<p>create a Labelme compatable json file</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>see lableme at <a href="https://github.com/wkentaro/labelme/blob/master/README.md">https://github.com/wkentaro/labelme/blob/master/README.md</a></p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="annotate_json" class="doc_header"><code>annotate_json</code><a href="https://github.com/johnnewto/cellsegment/tree/master/cellsegment/dataprep.py#L78" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>annotate_json</code>(<strong><code>data</code></strong>, <strong><code>shape_type</code></strong>=<em><code>'circle'</code></em>, <strong><code>points</code></strong>=<em><code>None</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="create_json_from_CSV" class="doc_header"><code>create_json_from_CSV</code><a href="https://github.com/johnnewto/cellsegment/tree/master/cellsegment/dataprep.py#L126" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>create_json_from_CSV</code>(<strong><code>csv_fn</code></strong>, <strong><code>load_jpg_fn</code></strong>, <strong><code>offset</code></strong>=<em><code>0</code></em>, <strong><code>height</code></strong>=<em><code>0</code></em>, <strong><code>width</code></strong>=<em><code>0</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="crop2well" class="doc_header"><code>crop2well</code><a href="https://github.com/johnnewto/cellsegment/tree/master/cellsegment/dataprep.py#L160" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>crop2well</code>(<strong><code>img</code></strong>, <strong><code>thres_adjust</code></strong>=<em><code>1.0</code></em>, <strong><code>bg_color</code></strong>=<em><code>[0, 0, 0]</code></em>, <strong><code>op</code></strong>=<em><code>'crop'</code></em>)</p>
</blockquote>
<p>Returns a square colour and gray image centered on the well with width same as the height.
thres_adjust is  optional otsu threshold scaling multiplier
Also returns the offset to the original image and the well region properties</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="well_circle_mask" class="doc_header"><code>well_circle_mask</code><a href="https://github.com/johnnewto/cellsegment/tree/master/cellsegment/dataprep.py#L191" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>well_circle_mask</code>(<strong><code>img</code></strong>, <strong><code>well_regionprops</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="check_well_crop" class="doc_header"><code>check_well_crop</code><a href="https://github.com/johnnewto/cellsegment/tree/master/cellsegment/dataprep.py#L195" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>check_well_crop</code>(<strong><code>img</code></strong>, <strong><code>well_regionprops</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="pad" class="doc_header"><code>pad</code><a href="https://github.com/johnnewto/cellsegment/tree/master/cellsegment/dataprep.py#L211" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>pad</code>(<strong><code>im</code></strong>, <strong><code>shape</code></strong>, <strong><code>offset</code></strong>, <strong><code>bg_color</code></strong>=<em><code>None</code></em>)</p>
</blockquote>
<p>array: Array to be padded
reference_shape: tuple of size of ndarray to create
offsets: list of offsets (number of elements must be equal to the dimension of the array)
will throw a ValueError if offsets is too big and the reference_shape cannot handle the offsets</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_image_size" class="doc_header"><code>get_image_size</code><a href="https://github.com/johnnewto/cellsegment/tree/master/cellsegment/dataprep.py#L233" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_image_size</code>(<strong><code>fn</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="resize_crop2well_one" class="doc_header"><code>resize_crop2well_one</code><a href="https://github.com/johnnewto/cellsegment/tree/master/cellsegment/dataprep.py#L237" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>resize_crop2well_one</code>(<strong><code>fn</code></strong>, <strong><code>i</code></strong>, <strong><code>src_path</code></strong>, <strong><code>dest_path</code></strong>, <strong><code>height</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="label_from_json" class="doc_header"><code>label_from_json</code><a href="https://github.com/johnnewto/cellsegment/tree/master/cellsegment/dataprep.py#L257" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>label_from_json</code>(<strong><code>data</code></strong>, <strong><code>img</code></strong>, <strong><code>plot</code></strong>=<em><code>False</code></em>, <strong><code>radius</code></strong>=<em><code>20</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="create_one_label" class="doc_header"><code>create_one_label</code><a href="https://github.com/johnnewto/cellsegment/tree/master/cellsegment/dataprep.py#L289" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>create_one_label</code>(<strong><code>fn</code></strong>, <strong><code>i</code></strong>, <strong><code>json_path</code></strong>, <strong><code>lab_path</code></strong>, <strong><code>colormap</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="resize_dir" class="doc_header"><code>resize_dir</code><a href="https://github.com/johnnewto/cellsegment/tree/master/cellsegment/dataprep.py#L307" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>resize_dir</code>(<strong><code>file_data</code></strong>, <strong><code>src_path</code></strong>, <strong><code>dest_path</code></strong>, <strong><code>number_files</code></strong>=<em><code>'all'</code></em>, <strong><code>height</code></strong>=<em><code>1200</code></em>)</p>
</blockquote>
<p>Resize  an entire directory. Store in the dest directory and append the source height in the file name
An example is  226260 - 1|0.436047|221|.jpg  where |0.436047|221| marks the factor and offset factors to apply
:param src_path:
:param dest_path:
:param number_files:
:param height:
:return:</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="resize_json_file" class="doc_header"><code>resize_json_file</code><a href="https://github.com/johnnewto/cellsegment/tree/master/cellsegment/dataprep.py#L337" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>resize_json_file</code>(<strong><code>fn</code></strong>, <strong><code>scale</code></strong>=<em><code>1</code></em>, <strong><code>offset</code></strong>=<em><code>0</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="resize_json_dir" class="doc_header"><code>resize_json_dir</code><a href="https://github.com/johnnewto/cellsegment/tree/master/cellsegment/dataprep.py#L353" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>resize_json_dir</code>(<strong><code>file_data</code></strong>, <strong><code>src_path</code></strong>, <strong><code>dest_path</code></strong>, <strong><code>number_files</code></strong>=<em><code>'all'</code></em>, <strong><code>height</code></strong>=<em><code>800</code></em>)</p>
</blockquote>
<p>Resize src_path directory of JSON files and store in dest_path directory
There needs to be resized jpg files in the dest_path directory.
An example is  226260 - 1|0.436047|221|.jpg  where |0.436047|221| marks the factor and offset factors to apply
:param src_path: Source path where json files are
:param dest_path: Destination path to store resized json files
:param number_files: Number of json files to process, leave empty for all files in directory
:return: number of file processed</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="shuffle_csv" class="doc_header"><code>shuffle_csv</code><a href="https://github.com/johnnewto/cellsegment/tree/master/cellsegment/dataprep.py#L386" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>shuffle_csv</code>(<strong><code>file_csv</code></strong>, <strong><code>random_state</code></strong>=<em><code>None</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="split_filenames" class="doc_header"><code>split_filenames</code><a href="https://github.com/johnnewto/cellsegment/tree/master/cellsegment/dataprep.py#L392" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>split_filenames</code>(<strong><code>file_csv</code></strong>, <strong><code>num_train</code></strong>=<em><code>0.7</code></em>, <strong><code>num_val</code></strong>=<em><code>0.15</code></em>)</p>
</blockquote>
<p>shuffle file names, split into train valid and test and update file_data.csv with labels</p>
<p>:param file_csv: csv file with file names and data
:param num_train:
:param num_val:
:param seed:
:return:</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="__crop_image" class="doc_header"><code>__crop_image</code><a href="https://github.com/johnnewto/cellsegment/tree/master/cellsegment/dataprep.py#L430" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>__crop_image</code>(<strong><code>jsonfn</code></strong>, <strong><code>imgfn</code></strong>, <strong><code>dest_path</code></strong>, <strong><code>size</code></strong>=<em><code>200</code></em>, <strong><code>op</code></strong>:<code>str</code>=<em><code>''</code></em>, <strong><code>debug</code></strong>=<em><code>False</code></em>)</p>
</blockquote>
<p>Crop an image into multiple sub-tiles centered on each egg
:param jsonfn: JSON file with egg centers
:param imgfn: image to be cropped
:param dest_path: directory to put cropped tiles into
:param size: pixel size of crop
:param filename_trim: remove the scale and offset portions of filename and remove extra spaces, 226260 - 1-0.436047-221-.jpg -&gt;  226260-1.jpg
:return: number of cropped images</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="crop_img_dir" class="doc_header"><code>crop_img_dir</code><a href="https://github.com/johnnewto/cellsegment/tree/master/cellsegment/dataprep.py#L493" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>crop_img_dir</code>(<strong><code>file_data</code></strong>:<code>str</code>, <strong><code>json_path</code></strong>:<code>str</code>, <strong><code>src_path</code></strong>:<code>str</code>, <strong><code>dest_path</code></strong>:<code>str</code>, <strong><code>number_files</code></strong>=<em><code>'all'</code></em>, <strong><code>DEBUG</code></strong>=<em><code>False</code></em>)</p>
</blockquote>
<p>Crop directory of image files based on json centers and store in dest directory</p>
<ul>
<li><code>file_data:</code>    file_data.csv</li>
<li><code>src_path:</code>     path where json files and image files to be cropped are</li>
<li><code>dest_path:</code>    Destination path to store cropped files</li>
<li><code>number_files:</code> Number of json files to process, leave empty for all files in directory</li>
<li><code>size:</code>         pixel size of crop</li>
<li><code>return:</code>       total number of cropped images`</li>
</ul>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="move_files_to_dir" class="doc_header"><code>move_files_to_dir</code><a href="https://github.com/johnnewto/cellsegment/tree/master/cellsegment/dataprep.py#L580" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>move_files_to_dir</code>(<strong><code>movefiles</code></strong>, <strong><code>srcpath</code></strong>, <strong><code>destpath</code></strong>, <strong><code>operation</code></strong>=<em><code>'move'</code></em>, <strong><code>extns</code></strong>=<em><code>['.jpg', '.json', '.png']</code></em>)</p>
</blockquote>
<p>Move random shuffle of the source directory to the Train, Val and Test directories</p>
<p>:param movefiles: list of files to move
:param srcpath: path where to src train files
:param destpath: path where to put test files
:param extns: list of extensions to try
:return: cnt of files_moved, files_missed</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="old_move_files_to_dir" class="doc_header"><code>old_move_files_to_dir</code><a href="https://github.com/johnnewto/cellsegment/tree/master/cellsegment/dataprep.py#L614" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>old_move_files_to_dir</code>(<strong><code>movefiles</code></strong>, <strong><code>srcpath</code></strong>, <strong><code>destpath</code></strong>, <strong><code>operation</code></strong>=<em><code>'move'</code></em>, <strong><code>extns</code></strong>=<em><code>['.jpg', '.json', '.png']</code></em>)</p>
</blockquote>
<p>Move random shuffle of the source directory to the Train, Val and Test directories</p>
<p>:param movefiles: list of files to move
:param srcpath: path where to src train files
:param destpath: path where to put test files
:param extns: list of extensions to try
:return: cnt of files_moved, files_missed</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="create_labels_dir" class="doc_header"><code>create_labels_dir</code><a href="https://github.com/johnnewto/cellsegment/tree/master/cellsegment/dataprep.py#L648" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>create_labels_dir</code>(<strong><code>json_path</code></strong>, <strong><code>dest_path</code></strong>, <strong><code>number_files</code></strong>=<em><code>'all'</code></em>)</p>
</blockquote>
<p>Create label png images based on CSV files and store in dest directory</p>
<p>:param json_path: Source path where json files are
:param dest_path: Destination path to store created png label files
:param number_files: Number of json files to process, leave empty for all files in directory
:return: nil</p>

</div>

</div>

</div>
</div>

</div>
</div>
 

