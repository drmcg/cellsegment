---

title: Example - markup_images  
keywords: fastai
sidebar: home_sidebar

summary: "**Model trained On the AM0.1-FLUKE dataset**  "
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/22_markup_images.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
    
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Setup-environment">Setup environment<a class="anchor-link" href="#Setup-environment">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Imports">Imports<a class="anchor-link" href="#Imports">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">cellsegment.core</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">cellsegment.inference_utils</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">cellsegment.set_directories</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">pandas</span>
<span class="kn">from</span> <span class="nn">fastai.vision</span> <span class="k">import</span> <span class="o">*</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Define-directories">Define directories<a class="anchor-link" href="#Define-directories">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">local_datapath</span> <span class="o">=</span> <span class="s1">&#39;../testdata_2&#39;</span>
<span class="c1"># local_datapath = &#39;../../data/FEC/03-M100-Fluke-2019-11/&#39;</span>

<span class="n">dirs</span> <span class="o">=</span> <span class="n">Dirs</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">IN_COLAB</span> <span class="k">else</span> <span class="n">Dirs</span><span class="p">(</span><span class="n">local_datapath</span><span class="p">)</span>
<span class="n">dirs</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">dirs</span><span class="o">.</span><span class="n">model</span> <span class="k">if</span> <span class="n">IN_COLAB</span> <span class="k">else</span> <span class="s1">&#39;/home/john/github/data/FEC/03-M100-Fluke-2019-11/models&#39;</span>

<span class="nb">print</span><span class="p">(</span><span class="n">dirs</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>None
  basepath        :  ../testdata_2        
  crop            :  ../testdata_2/Crop-200 
  cropLabel       :  ../testdata_2/Crop-200/Label 
  cropTest        :  ../testdata_2/Crop-200/Test 
  cropTrain       :  ../testdata_2/Crop-200/Train 
  cropValidTxtFile:  ../testdata_2/Crop-200/valid.txt 
  label           :  ../testdata_2/Fullsize/Label 
  model           :  /home/john/github/data/FEC/03-M100-Fluke-2019-11/models 
  originImages    :  ../testdata_2/Original 
  sizeCsvFile     :  ../testdata_2/file_size.csv 
  test            :  ../testdata_2/Fullsize/Test 
  train           :  ../testdata_2/Fullsize/Train 
  validTxtFile    :  ../testdata_2/Fullsize/valid.txt 

</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Load-the-Training-Images">Load the Training Images<a class="anchor-link" href="#Load-the-Training-Images">&#182;</a></h3><p>(if in colab)</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span>%%bash
<span class="o">[[</span> ! -e /tools/google-cloud-sdk <span class="o">]]</span> <span class="o">&amp;&amp;</span>  <span class="nb">exit</span> <span class="c1"># if in colab</span>

    <span class="nb">export</span> <span class="nv">fileid</span><span class="o">=</span>1SEW0Kf1CI4e4-up4TGsDqwDwVk_QZEUf
    <span class="nb">export</span> <span class="nv">filename</span><span class="o">=</span>Fluke-Train-2019-12-01.zip

    <span class="c1">## CURL ##</span>
    curl -L -c cookies.txt <span class="s1">&#39;https://docs.google.com/uc?export=download&amp;id=&#39;</span><span class="nv">$fileid</span> <span class="se">\</span>
         <span class="p">|</span> sed -rn <span class="s1">&#39;s/.*confirm=([0-9A-Za-z_]+).*/\1/p&#39;</span> &gt; confirm.txt
    curl -L -b cookies.txt -o <span class="nv">$filename</span> <span class="se">\</span>
         <span class="s1">&#39;https://docs.google.com/uc?export=download&amp;id=&#39;</span><span class="nv">$fileid</span><span class="s1">&#39;&amp;confirm=&#39;</span><span class="k">$(</span>&lt;confirm.txt<span class="k">)</span>
    rm -f confirm.txt cookies.txt
    
    unzip -u -q <span class="nv">$filename</span> -d data
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Load-exported-Model">Load exported Model<a class="anchor-link" href="#Load-exported-Model">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span>%%bash
<span class="o">[[</span> ! -e /tools/google-cloud-sdk <span class="o">]]</span> <span class="o">&amp;&amp;</span>  <span class="nb">exit</span> <span class="c1"># if in colab</span>
<span class="nv">switch</span><span class="o">=</span><span class="nb">true</span>
<span class="k">if</span> <span class="nv">$switch</span><span class="p">;</span> <span class="k">then</span>  
    <span class="nb">export</span> <span class="nv">fileid</span><span class="o">=</span>11cZWhg23QDag_3b7jcd02U8Pzq3W6U5Y
    <span class="nb">export</span> <span class="nv">filename</span><span class="o">=</span>export-fluke-2019-12-01.pkl

    <span class="c1">## CURL ##</span>
    curl -L -c cookies.txt <span class="s1">&#39;https://docs.google.com/uc?export=download&amp;id=&#39;</span><span class="nv">$fileid</span> <span class="se">\</span>
         <span class="p">|</span> sed -rn <span class="s1">&#39;s/.*confirm=([0-9A-Za-z_]+).*/\1/p&#39;</span> &gt; confirm.txt
    curl -L -b cookies.txt -o <span class="nv">$filename</span> <span class="se">\</span>
         <span class="s1">&#39;https://docs.google.com/uc?export=download&amp;id=&#39;</span><span class="nv">$fileid</span><span class="s1">&#39;&amp;confirm=&#39;</span><span class="k">$(</span>&lt;confirm.txt<span class="k">)</span>
    rm -f confirm.txt cookies.txt
<span class="k">fi</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Run-model-inference-on-all-of-the-test-tiles">Run model inference on all of the test tiles<a class="anchor-link" href="#Run-model-inference-on-all-of-the-test-tiles">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">dirs</span><span class="o">.</span><span class="n">crop</span><span class="p">)</span>
<span class="n">fnames</span> <span class="o">=</span>  <span class="n">get_image_files</span><span class="p">(</span><span class="n">path</span><span class="o">/</span><span class="s1">&#39;Test&#39;</span><span class="p">)</span>

<span class="nb">print</span> <span class="p">(</span><span class="n">f</span><span class="s1">&#39;Number of test tiles {len(fnames)}&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Number of test tiles 13
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Create-Learner-from-exported-model">Create Learner from exported model<a class="anchor-link" href="#Create-Learner-from-exported-model">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># defaults.device = &#39;cpu&#39;</span>
<span class="n">defaults</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="s1">&#39;cuda&#39;</span>
<span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>

    <span class="k">def</span> <span class="nf">acc_metric1</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">==</span><span class="n">target</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">acc_metric2</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="n">target</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="n">target</span><span class="p">[</span><span class="n">target</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

    <span class="n">fn_model</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;</span><span class="si">{dirs.model}</span><span class="s1">/export-fluke-2019-12-01.pkl&#39;</span>
    <span class="n">learn</span> <span class="o">=</span> <span class="n">load_learner</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">fn_model</span><span class="p">)</span>

    <span class="n">learn</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
    <span class="c1"># summary(learn.model, (3, 32, 32))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Learner loaded&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Learner not loaded as torch.cuda.is_available() = &quot;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">())</span>
    
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Learner loaded
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="utilities">utilities<a class="anchor-link" href="#utilities">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">padImage_t</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">pad</span> <span class="ow">and</span> <span class="n">pad</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">F</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">img</span><span class="o">.</span><span class="n">px</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="p">(</span><span class="n">pad</span><span class="p">,</span> <span class="n">pad</span><span class="p">,</span> <span class="n">pad</span><span class="p">,</span> <span class="n">pad</span><span class="p">),</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;constant&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">img</span>

<span class="k">def</span> <span class="nf">cut_tiles_t</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">TM</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">TN</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
    <span class="n">M</span><span class="p">,</span> <span class="n">N</span> <span class="o">=</span> <span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">pad</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span><span class="o">//</span><span class="n">TM</span><span class="p">,</span> <span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">pad</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span><span class="o">//</span><span class="n">TN</span> 
    <span class="n">OM</span><span class="p">,</span> <span class="n">ON</span> <span class="o">=</span> <span class="n">pad</span> <span class="o">+</span> <span class="n">M</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">pad</span> <span class="o">+</span> <span class="n">N</span><span class="o">//</span><span class="mi">2</span>   
    <span class="k">return</span> <span class="p">[</span><span class="n">Image</span><span class="p">(</span><span class="n">img</span><span class="p">[:,</span><span class="n">x</span><span class="o">-</span><span class="n">OM</span><span class="p">:</span><span class="n">x</span><span class="o">+</span><span class="n">OM</span><span class="p">,</span><span class="n">y</span><span class="o">-</span><span class="n">ON</span><span class="p">:</span><span class="n">y</span><span class="o">+</span><span class="n">ON</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">pad</span><span class="o">+</span><span class="n">M</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">M</span><span class="p">)</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">pad</span><span class="o">+</span><span class="n">N</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">N</span><span class="p">)]</span>

<span class="k">def</span> <span class="nf">lay_tiles_t</span><span class="p">(</span><span class="n">tiles</span><span class="p">,</span> <span class="n">TM</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">TN</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
    <span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">M</span><span class="p">,</span><span class="n">N</span><span class="p">)</span> <span class="o">=</span> <span class="n">tiles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
    <span class="n">OM</span><span class="p">,</span> <span class="n">ON</span> <span class="o">=</span> <span class="n">pad</span> <span class="o">+</span> <span class="n">M</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">pad</span> <span class="o">+</span> <span class="n">N</span><span class="o">//</span><span class="mi">2</span>  
    <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">tile</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tiles</span><span class="p">):</span>
        <span class="n">tiles</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">tile</span><span class="p">[:,</span><span class="n">pad</span><span class="p">:</span><span class="o">-</span><span class="p">(</span><span class="n">pad</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="n">pad</span><span class="p">:</span><span class="o">-</span><span class="p">(</span><span class="n">pad</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
    
    <span class="n">hstack</span> <span class="o">=</span> <span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">tiles</span><span class="p">[</span><span class="n">y</span><span class="p">:</span><span class="n">y</span><span class="o">+</span><span class="n">TN</span><span class="p">],</span><span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">TN</span><span class="o">*</span><span class="n">TM</span><span class="p">,</span><span class="n">TN</span><span class="p">)]</span>  
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">hstack</span><span class="p">,</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">run_prediction</span><span class="p">(</span><span class="n">learn</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">classes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">filesavedir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tile</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    run predictions and return dictionary of raw predictions</span>
<span class="sd">    :param learn: </span>
<span class="sd">    :param fn: </span>
<span class="sd">    :param classes: </span>
<span class="sd">    :param tile: </span>
<span class="sd">    :param pad: </span>
<span class="sd">    :return: </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">open_image</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">tile</span><span class="p">:</span>
        <span class="n">pad</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="n">TM</span><span class="p">,</span> <span class="n">TN</span> <span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">padImage_t</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="n">pad</span><span class="p">)</span>
        <span class="n">tiles</span> <span class="o">=</span> <span class="n">cut_tiles_t</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">TM</span><span class="o">=</span><span class="n">TM</span><span class="p">,</span> <span class="n">TN</span><span class="o">=</span><span class="n">TN</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="n">pad</span><span class="p">)</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">learn</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">im</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">im</span> <span class="ow">in</span> <span class="n">tiles</span><span class="p">]</span>
        <span class="n">raw_pred</span> <span class="o">=</span> <span class="n">lay_tiles_t</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">TM</span><span class="o">=</span><span class="n">TM</span><span class="p">,</span> <span class="n">TN</span><span class="o">=</span><span class="n">TN</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="n">pad</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">%</span><span class="k">2</span> == 1:   # make odd dimension make even for unet
           <span class="n">img</span><span class="o">.</span><span class="n">px</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">px</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">:]</span> 
        <span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">raw_pred</span> <span class="o">=</span> <span class="n">learn</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
      
    <span class="n">preds</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="p">:</span><span class="n">raw_pred</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">classes</span><span class="p">)}</span>
    <span class="k">if</span> <span class="n">filesavedir</span><span class="p">:</span>
        <span class="k">for</span> <span class="bp">cls</span><span class="p">,</span><span class="n">raw_pred</span> <span class="ow">in</span> <span class="n">preds</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">raw_pred</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">lbl_pil</span> <span class="o">=</span> <span class="n">PIL</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">to_np</span><span class="p">(</span><span class="n">raw_pred</span><span class="o">*</span><span class="mi">255</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">))</span>
            <span class="n">lbl_pil</span> <span class="o">=</span> <span class="n">lbl_pil</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="n">PIL</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">ADAPTIVE</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="mi">256</span><span class="p">)</span>
            <span class="n">lbl_pil</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{filesavedir}</span><span class="s1">/</span><span class="si">{fn.stem}</span><span class="s1">-</span><span class="si">{cls}</span><span class="s1">.png&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">preds</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">img_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">dirs</span><span class="o">.</span><span class="n">train</span><span class="p">)</span>
<span class="n">mrk_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;../testdata_2/Fullsize/markup&#39;</span><span class="p">)</span>  
<span class="n">mrk_path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">fnames</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">get_image_files</span><span class="p">(</span><span class="n">img_path</span><span class="p">))</span>
<span class="n">classes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Background&#39;</span><span class="p">,</span> <span class="s1">&#39;Fluke_Liver&#39;</span><span class="p">,</span> <span class="s1">&#39;Fluke_Rumen&#39;</span><span class="p">,</span> <span class="s1">&#39;Other&#39;</span><span class="p">]</span>

<span class="c1"># fnames = fnames[600:]</span>
<span class="n">fnames</span> <span class="o">=</span> <span class="n">fnames</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Number images to process {len(fnames)}&quot;</span><span class="p">)</span>
<span class="n">preds</span> <span class="o">=</span> <span class="n">run_prediction</span><span class="p">(</span><span class="n">learn</span><span class="p">,</span> <span class="n">fnames</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">classes</span><span class="o">=</span><span class="n">classes</span><span class="p">,</span> <span class="n">tile</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">filesavedir</span><span class="o">=</span><span class="n">mrk_path</span><span class="p">)</span>
<span class="n">preds</span><span class="p">[</span><span class="s1">&#39;Background&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
<span class="c1"># for fn in fnames:</span>
<span class="c1">#     print(fn)</span>
<span class="c1">#     pred_img = unet_predict_eggs(fn)</span>
<span class="c1">#     PIL.Image.fromarray((pred_img*255).astype(np.uint8)).save(f&#39;{mrk_path}/{fn.stem}.png&#39;)  </span>
<span class="c1"># show_img(pred_img)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Number images to process 3
Background torch.Size([800, 816])
Fluke_Liver torch.Size([800, 816])
Fluke_Rumen torch.Size([800, 816])
Other torch.Size([800, 816])
</pre>
</div>
</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>torch.Size([800, 816])</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">## Class Analyse Predictions</span>
<span class="c1"># import pdb; pdb.set_trace()</span>
<span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">from</span> <span class="nn">skimage.measure</span> <span class="k">import</span> <span class="n">label</span><span class="p">,</span> <span class="n">regionprops</span>
<span class="kn">from</span> <span class="nn">skimage</span> <span class="k">import</span> <span class="n">filters</span>
<span class="kn">from</span> <span class="nn">skimage.morphology</span> <span class="k">import</span> <span class="n">erosion</span><span class="p">,</span> <span class="n">dilation</span><span class="p">,</span> <span class="n">opening</span><span class="p">,</span> <span class="n">closing</span><span class="p">,</span> <span class="n">disk</span>
<span class="kn">from</span> <span class="nn">scipy.spatial</span> <span class="k">import</span> <span class="n">distance</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">pandas</span> <span class="k">import</span> <span class="n">DataFrame</span>

<span class="k">class</span> <span class="nc">AnalysePredictions</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Methods for preparing and the inference of Well images&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;What to do here&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_paths</span><span class="p">();</span>

    <span class="k">def</span> <span class="nf">set_paths</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">img_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mrk_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">base_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">base_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">()</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">img_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">img_path</span> <span class="o">=</span> <span class="n">base_path</span><span class="o">/</span><span class="n">Path</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">mrk_path</span> <span class="o">=</span> <span class="n">base_path</span><span class="o">/</span><span class="n">Path</span><span class="p">(</span><span class="n">mrk_path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">img_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;data/images/&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mrk_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;data/markup/&#39;</span><span class="p">)</span>
        
    <span class="c1"># NP coder for Tile  into  MxN sections to reduce memory footprint</span>
    <span class="k">def</span> <span class="nf">padImage_np</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
      <span class="k">if</span> <span class="n">padding</span> <span class="ow">and</span> <span class="n">padding</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">img</span><span class="p">[:,:,</span><span class="n">c</span><span class="p">],</span> <span class="n">padding</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;constant&#39;</span><span class="p">,</span> <span class="n">constant_values</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">img</span>

    <span class="k">def</span> <span class="nf">cut_tiles_np</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">TM</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">TN</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
      <span class="n">M</span><span class="p">,</span> <span class="n">N</span> <span class="o">=</span> <span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">pad</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span><span class="o">//</span><span class="n">TM</span><span class="p">,</span> <span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">pad</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span><span class="o">//</span><span class="n">TN</span> 
      <span class="n">OM</span><span class="p">,</span> <span class="n">ON</span> <span class="o">=</span> <span class="n">pad</span> <span class="o">+</span> <span class="n">M</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">pad</span> <span class="o">+</span> <span class="n">N</span><span class="o">//</span><span class="mi">2</span>
      <span class="k">return</span> <span class="p">[</span><span class="n">img</span><span class="p">[</span><span class="n">x</span><span class="o">-</span><span class="n">OM</span><span class="p">:</span><span class="n">x</span><span class="o">+</span><span class="n">OM</span><span class="p">,</span><span class="n">y</span><span class="o">-</span><span class="n">ON</span><span class="p">:</span><span class="n">y</span><span class="o">+</span><span class="n">ON</span><span class="p">,:]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">pad</span><span class="o">+</span><span class="n">M</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">M</span><span class="p">)</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">pad</span><span class="o">+</span><span class="n">N</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">N</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">lay_tiles_np</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tiles</span><span class="p">,</span> <span class="n">TM</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">TN</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
      <span class="n">OM</span><span class="p">,</span> <span class="n">ON</span> <span class="o">=</span> <span class="n">pad</span> <span class="o">+</span> <span class="n">TM</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">pad</span> <span class="o">+</span> <span class="n">TN</span><span class="o">//</span><span class="mi">2</span>
      <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">tile</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tiles</span><span class="p">):</span>
        <span class="n">tiles</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">tile</span><span class="p">[</span><span class="n">pad</span><span class="p">:</span><span class="o">-</span><span class="n">pad</span><span class="p">,</span><span class="n">pad</span><span class="p">:</span><span class="o">-</span><span class="n">pad</span><span class="p">,:]</span>

      <span class="n">hstack</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">tiles</span><span class="p">[</span><span class="n">y</span><span class="p">:</span><span class="n">y</span><span class="o">+</span><span class="n">TN</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">TN</span><span class="o">*</span><span class="n">TM</span><span class="p">,</span><span class="n">TN</span><span class="p">)]</span>  
      <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">hstack</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_tile_np</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">to_np</span><span class="p">(</span><span class="n">open_image</span><span class="p">(</span><span class="s1">&#39;data/subset/220972 - 1.jpg&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="mi">800</span><span class="p">)</span><span class="o">.</span><span class="n">px</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">padImage_np</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="n">tiles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cut_tiles_np</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="n">vstack</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lay_tiles_np</span><span class="p">(</span><span class="n">tiles</span><span class="p">,</span> <span class="n">TM</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">TN</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
        <span class="n">show_img</span><span class="p">(</span><span class="n">vstack</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>

    <span class="c1">## Tensor coder for Tile  into  MxN sections to reduce memory footprint</span>

    <span class="k">def</span> <span class="nf">padImage_t</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
      <span class="k">if</span> <span class="n">pad</span> <span class="ow">and</span> <span class="n">pad</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">F</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">img</span><span class="o">.</span><span class="n">px</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="p">(</span><span class="n">pad</span><span class="p">,</span> <span class="n">pad</span><span class="p">,</span> <span class="n">pad</span><span class="p">,</span> <span class="n">pad</span><span class="p">),</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;constant&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">img</span>

    <span class="k">def</span> <span class="nf">cut_tiles_t</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">TM</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">TN</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
      <span class="n">M</span><span class="p">,</span> <span class="n">N</span> <span class="o">=</span> <span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">pad</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span><span class="o">//</span><span class="n">TM</span><span class="p">,</span> <span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">pad</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span><span class="o">//</span><span class="n">TN</span> 
      <span class="n">OM</span><span class="p">,</span> <span class="n">ON</span> <span class="o">=</span> <span class="n">pad</span> <span class="o">+</span> <span class="n">M</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">pad</span> <span class="o">+</span> <span class="n">N</span><span class="o">//</span><span class="mi">2</span>  
      <span class="k">return</span> <span class="p">[</span><span class="n">Image</span><span class="p">(</span><span class="n">img</span><span class="p">[:,</span><span class="n">x</span><span class="o">-</span><span class="n">OM</span><span class="p">:</span><span class="n">x</span><span class="o">+</span><span class="n">OM</span><span class="p">,</span><span class="n">y</span><span class="o">-</span><span class="n">ON</span><span class="p">:</span><span class="n">y</span><span class="o">+</span><span class="n">ON</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">pad</span><span class="o">+</span><span class="n">M</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">M</span><span class="p">)</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">pad</span><span class="o">+</span><span class="n">N</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">N</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">lay_tiles_t</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tiles</span><span class="p">,</span> <span class="n">TM</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">TN</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
      <span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">M</span><span class="p">,</span><span class="n">N</span><span class="p">)</span> <span class="o">=</span> <span class="n">tiles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
      <span class="n">OM</span><span class="p">,</span> <span class="n">ON</span> <span class="o">=</span> <span class="n">pad</span> <span class="o">+</span> <span class="n">M</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">pad</span> <span class="o">+</span> <span class="n">N</span><span class="o">//</span><span class="mi">2</span>  
      <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">tile</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tiles</span><span class="p">):</span>
        <span class="n">tiles</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">tile</span><span class="p">[:,</span><span class="n">pad</span><span class="p">:</span><span class="o">-</span><span class="p">(</span><span class="n">pad</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="n">pad</span><span class="p">:</span><span class="o">-</span><span class="p">(</span><span class="n">pad</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>

      <span class="n">hstack</span> <span class="o">=</span> <span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">tiles</span><span class="p">[</span><span class="n">y</span><span class="p">:</span><span class="n">y</span><span class="o">+</span><span class="n">TN</span><span class="p">],</span><span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">TN</span><span class="o">*</span><span class="n">TM</span><span class="p">,</span><span class="n">TN</span><span class="p">)]</span>  
      <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">hstack</span><span class="p">,</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_tile_t</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">open_image</span><span class="p">(</span><span class="s1">&#39;data/subset/220972 - 1.jpg&#39;</span><span class="p">)</span>
        <span class="c1"># img = to_np(open_image(&#39;data/subset/220972 - 1.jpg&#39;).resize(800).px).transpose(1,2,0)</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">padImage_t</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="n">tiles</span> <span class="o">=</span> <span class="n">cut_tiles_t</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">tile</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tiles</span><span class="p">):</span>
            <span class="n">tiles</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">tile</span><span class="o">.</span><span class="n">px</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">tile</span><span class="o">.</span><span class="n">px</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="n">vstack</span> <span class="o">=</span> <span class="n">lay_tiles_t</span><span class="p">(</span><span class="n">tiles</span><span class="p">)</span>
        <span class="n">Image</span><span class="p">(</span><span class="n">vstack</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>

    <span class="c1">## Drawing annotation labels on an image</span>
    <span class="k">def</span> <span class="nf">draw_labels_cv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">json</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mi">40</span><span class="p">):</span>
      <span class="n">font</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">FONT_HERSHEY_SIMPLEX</span>
      <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">sh</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">json</span><span class="p">[</span><span class="s1">&#39;shapes&#39;</span><span class="p">]):</span>
        <span class="k">if</span> <span class="n">sh</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">][:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Str&quot;</span><span class="p">:</span>
          <span class="n">fill</span> <span class="o">=</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">sh</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">][:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Nem&quot;</span><span class="p">:</span>
          <span class="n">fill</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[Error]: unknown label&#39;</span><span class="p">)</span>

        <span class="n">draw</span> <span class="o">=</span> <span class="s1">&#39;None&#39;</span>  
        <span class="k">if</span> <span class="n">sh</span><span class="p">[</span><span class="s1">&#39;shape_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;circle&#39;</span><span class="p">:</span>
          <span class="n">draw</span> <span class="o">=</span> <span class="s1">&#39;circle&#39;</span>
          <span class="n">probability</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">sh</span><span class="p">[</span><span class="s1">&#39;probability&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="s1">&#39;probability&#39;</span> <span class="ow">in</span> <span class="n">sh</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="k">elif</span> <span class="n">sh</span><span class="p">[</span><span class="s1">&#39;shape_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;rectangle&#39;</span><span class="p">:</span>
          <span class="n">draw</span> <span class="o">=</span> <span class="s1">&#39;rectangle&#39;</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Unknown shape_type&quot;</span><span class="p">,</span> <span class="n">sh</span><span class="p">[</span><span class="s1">&#39;shape_type&#39;</span><span class="p">])</span>


        <span class="n">xy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">sh</span><span class="p">[</span><span class="s2">&quot;points&quot;</span><span class="p">])</span>
        <span class="n">ave</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">xy</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">cx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ave</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">cy</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ave</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">draw</span> <span class="o">==</span> <span class="s1">&#39;circle&#39;</span><span class="p">:</span>
          <span class="n">cv2</span><span class="o">.</span><span class="n">circle</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">),</span> <span class="n">radius</span><span class="p">,</span> <span class="n">fill</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
          <span class="n">cv2</span><span class="o">.</span><span class="n">circle</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">),</span> <span class="n">radius</span><span class="p">,</span> <span class="n">fill</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
          <span class="n">cv2</span><span class="o">.</span><span class="n">putText</span><span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="n">probability</span><span class="p">,(</span><span class="nb">int</span><span class="p">(</span><span class="n">cx</span><span class="o">-</span><span class="n">radius</span><span class="p">),</span> <span class="n">cy</span><span class="o">-</span><span class="n">radius</span><span class="p">),</span> <span class="n">font</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fill</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">LINE_AA</span><span class="p">)</span>


        <span class="k">elif</span> <span class="n">draw</span> <span class="o">==</span> <span class="s1">&#39;rectangle&#39;</span><span class="p">:</span>
          <span class="n">cv2</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="p">(</span><span class="n">cx</span> <span class="o">-</span> <span class="n">radius</span><span class="p">,</span> <span class="n">cy</span> <span class="o">-</span> <span class="n">radius</span><span class="p">),</span> <span class="p">(</span><span class="n">cx</span> <span class="o">+</span> <span class="n">radius</span><span class="p">,</span> <span class="n">cy</span> <span class="o">+</span> <span class="n">radius</span><span class="p">),</span> <span class="n">fill</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

      <span class="k">return</span> <span class="n">img</span>
    <span class="k">def</span> <span class="nf">test_draw_labels_cv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">img_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;data/subset/&#39;</span><span class="p">)</span>
        <span class="n">tst_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;data/test/&#39;</span><span class="p">)</span>  
        <span class="n">tst_path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;data/markup/220966 - 1.png&#39;</span><span class="p">)</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">PIL</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fn</span><span class="p">))</span>
        <span class="n">_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s1">&#39;data/markup/220966 - 1.json&#39;</span><span class="p">))</span>
        <span class="n">mrk_img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">draw_labels_cv</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">_json</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mi">40</span><span class="p">)</span> 
        <span class="n">show_img</span><span class="p">(</span><span class="n">mrk_img</span><span class="p">[:</span><span class="mi">500</span><span class="p">,</span><span class="mi">1000</span><span class="p">:</span><span class="mi">1500</span><span class="p">,:],</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
        <span class="n">PIL</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">mrk_img</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">))</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{tst_path}</span><span class="s1">/</span><span class="si">{fn.stem}</span><span class="s1">.jpg&#39;</span><span class="p">,</span> <span class="n">quality</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span> 

    <span class="c1">## </span>
    <span class="k">def</span> <span class="nf">find_prediction_blobs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">CONF</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span> 
        <span class="c1"># region props seems to have region.max_intensity errors if no data not np.int </span>
        <span class="n">SCALE</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="n">CONF</span> <span class="o">*=</span> <span class="n">SCALE</span>
        <span class="n">selem</span> <span class="o">=</span> <span class="n">disk</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
    <span class="c1">#     img = filters.gaussian(img, sigma= 1 / 40, multichannel=True)</span>
        <span class="n">img</span> <span class="o">=</span> <span class="p">(</span><span class="n">img</span> <span class="o">*</span> <span class="p">(</span><span class="n">SCALE</span><span class="o">/</span><span class="n">img</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
        <span class="n">img</span><span class="p">[</span><span class="n">img</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="n">CONF</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">img</span><span class="p">[</span><span class="n">img</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;</span><span class="n">CONF</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1">#     img[:,:,0] = img[:,:,0] &gt; CONF</span>
    <span class="c1">#     img[:,:,1] = img[:,:,1] &gt; CONF</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1">#     imgL = img[:,:,0].astype(np.int)</span>
    <span class="c1">#     img[:,:,0] = closing(img[:,:,0], selem)</span>
    <span class="c1">#     img[:,:,1] = closing(img[:,:,1], selem)</span>
    <span class="c1">#     img[:,:,0] = opening(img[:,:,0], selem)</span>
    <span class="c1">#     img[:,:,1] = opening(img[:,:,1], selem)</span>

        <span class="n">fill</span> <span class="o">=</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">label_image0</span> <span class="o">=</span> <span class="n">label</span><span class="p">(</span><span class="n">img</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">CONF</span><span class="p">)</span>
        <span class="n">label_image1</span> <span class="o">=</span> <span class="n">label</span><span class="p">(</span><span class="n">img</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">CONF</span><span class="p">)</span>

<span class="c1">#         img = img.copy()  # helped with a cv error?</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">img</span><span class="p">)</span> <span class="c1"># helped with a cv error?</span>
        <span class="k">for</span> <span class="n">region</span> <span class="ow">in</span> <span class="n">regionprops</span><span class="p">(</span><span class="n">label_image0</span><span class="p">,</span> <span class="n">img</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">region</span><span class="o">.</span><span class="n">area</span> <span class="o">&gt;</span> <span class="mi">500</span><span class="p">:</span>
                <span class="n">cx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">region</span><span class="o">.</span><span class="n">centroid</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">cy</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">region</span><span class="o">.</span><span class="n">centroid</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="c1">#                 import pdb; pdb.set_trace()</span>
<span class="c1">#                 cv2.rectangle(img, (cx - radius, cy - radius), (cx + radius, cy + radius), fill, 5)</span>
                <span class="n">predictions</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s1">&#39;Strongyle&#39;</span><span class="p">,</span> <span class="s2">&quot;point&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">cx</span><span class="p">,</span><span class="n">cy</span><span class="p">],</span> <span class="s2">&quot;probability&quot;</span><span class="p">:</span> <span class="n">region</span><span class="o">.</span><span class="n">max_intensity</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)})</span>  
    <span class="c1">#             print(&#39; 0:&#39;, [cx,cy], &#39;area:&#39;,  region.area, </span>
    <span class="c1">#                   &#39;max&#39;,  region.max_intensity.round(2), </span>
    <span class="c1">#                   &#39;mean&#39;, region.mean_intensity.round(2))</span>
        <span class="n">fill</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">img</span><span class="p">)</span> <span class="c1"># helped with a cv error?</span>
        <span class="k">for</span> <span class="n">region</span> <span class="ow">in</span> <span class="n">regionprops</span><span class="p">(</span><span class="n">label_image1</span><span class="p">,</span> <span class="n">img</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">region</span><span class="o">.</span><span class="n">area</span> <span class="o">&gt;</span> <span class="mi">500</span><span class="p">:</span>
                <span class="n">cx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">region</span><span class="o">.</span><span class="n">centroid</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">cy</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">region</span><span class="o">.</span><span class="n">centroid</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="c1">#                 cv2.rectangle(img, (cx - radius, cy - radius), (cx + radius, cy + radius), fill, 5)</span>
                <span class="n">predictions</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s1">&#39;Nematodirus&#39;</span><span class="p">,</span><span class="s2">&quot;point&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">cx</span><span class="p">,</span><span class="n">cy</span><span class="p">],</span> <span class="s2">&quot;probability&quot;</span><span class="p">:</span> <span class="n">region</span><span class="o">.</span><span class="n">max_intensity</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)})</span>
    <span class="c1">#             print(f&#39; 1: area {region.area}, max intensity {region.max_intensity.round(5)}&#39;)</span>
    <span class="c1">#         #     print(region.area)</span>
        <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
            <span class="c1">#   show_img(imglab, figsize = (15,15))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">121</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">label_image0</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;nipy_spectral&#39;</span><span class="p">)</span>
            <span class="c1">#   plt.imshow(img[:,:,0] &gt; CONF, cmap=&#39;nipy_spectral&#39;)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">122</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">label_image1</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;nipy_spectral&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">img</span>
    <span class="k">def</span> <span class="nf">test_find_prediction_blobs</span><span class="p">(</span><span class="bp">self</span> <span class="p">):</span> 
    <span class="c1">#     fn = &#39;data/markup/220966 - 1.png&#39;</span>
        <span class="n">tst_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;data/test/&#39;</span><span class="p">)</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;data/markup/221221 - 1.png&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Testing: def test_find_prediction_blobs(&#39;</span><span class="si">{fn}</span><span class="s2">&#39;):&quot;</span><span class="p">)</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">PIL</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fn</span><span class="p">))</span>


        <span class="n">anno_list</span><span class="p">,</span> <span class="n">proc_img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_prediction_blobs</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Max value&quot;</span><span class="p">,</span> <span class="n">proc_img</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
        <span class="n">PIL</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">proc_img</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">))</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{tst_path}</span><span class="s1">/</span><span class="si">{fn.stem}</span><span class="s1">.png&#39;</span><span class="p">)</span> 
    <span class="c1">#     print(anno_list)</span>

    <span class="c1">## Annotate the json file with predictions</span>
    <span class="k">def</span> <span class="nf">annotate_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">annotations</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">add_anno</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
            <span class="n">r</span> <span class="o">=</span> <span class="mi">40</span>
            <span class="n">cx</span><span class="p">,</span><span class="n">cy</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;point&#39;</span><span class="p">]</span>
            <span class="n">pnt_list</span> <span class="o">=</span> <span class="p">[[</span><span class="n">cx</span><span class="o">-</span><span class="n">r</span><span class="p">,</span><span class="n">cy</span><span class="o">-</span><span class="n">r</span><span class="p">],</span> <span class="p">[</span><span class="n">cx</span><span class="o">+</span><span class="n">r</span><span class="p">,</span><span class="n">cy</span><span class="o">+</span><span class="n">r</span><span class="p">]]</span>

            <span class="n">probability</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;probability&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="s1">&#39;probability&#39;</span> <span class="ow">in</span> <span class="n">item</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">][:</span><span class="mi">3</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;Str&#39;</span><span class="p">:</span> 
                <span class="n">line_color</span> <span class="o">=</span> <span class="p">[</span><span class="mi">255</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">127</span><span class="p">]</span>
                <span class="n">data</span><span class="p">[</span><span class="s1">&#39;shapes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">],</span><span class="s2">&quot;line_color&quot;</span><span class="p">:</span> <span class="n">line_color</span><span class="p">,</span> <span class="s2">&quot;fill_color&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="s2">&quot;points&quot;</span><span class="p">:</span> <span class="n">pnt_list</span><span class="p">,</span> <span class="s2">&quot;shape_type&quot;</span><span class="p">:</span> <span class="s2">&quot;circle&quot;</span><span class="p">,</span> <span class="s1">&#39;probability&#39;</span><span class="p">:</span> <span class="n">probability</span>
            <span class="p">})</span>      

            <span class="k">elif</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">][:</span><span class="mi">3</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;Nem&#39;</span><span class="p">:</span> 
                <span class="n">line_color</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">127</span><span class="p">]</span>
                <span class="n">data</span><span class="p">[</span><span class="s1">&#39;shapes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">],</span><span class="s2">&quot;line_color&quot;</span><span class="p">:</span> <span class="n">line_color</span><span class="p">,</span> <span class="s2">&quot;fill_color&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="s2">&quot;points&quot;</span><span class="p">:</span> <span class="n">pnt_list</span><span class="p">,</span> <span class="s2">&quot;shape_type&quot;</span><span class="p">:</span> <span class="s2">&quot;circle&quot;</span><span class="p">,</span> <span class="s1">&#39;probability&#39;</span><span class="p">:</span> <span class="n">probability</span>
                <span class="p">})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Unknown label&#39;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">add_annotations</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">annotations</span><span class="p">):</span> 
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">annotations</span><span class="p">:</span>
                <span class="n">add_anno</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">del_circle_annotations</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
            <span class="n">to_del</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span><span class="n">sh</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;shapes&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="n">sh</span><span class="p">[</span><span class="s1">&#39;shape_type&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;circle&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">to_del</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> 
                <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Deleting {len(to_del)} circle annotations&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">to_del</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                <span class="k">del</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;shapes&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>        

        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">fn</span><span class="p">))</span>
        <span class="n">del_circle_annotations</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">add_annotations</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">annotations</span><span class="p">)</span> 
        <span class="k">return</span> <span class="n">data</span>

    <span class="k">def</span> <span class="nf">test_annotate_json</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  
      <span class="n">fn</span> <span class="o">=</span> <span class="s1">&#39;data/markup/220966 - 1.png&#39;</span>
      <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">PIL</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fn</span><span class="p">))</span>

      <span class="n">predictions</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_prediction_blobs</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
      <span class="nb">print</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span>
      <span class="n">data</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotate_json</span><span class="p">(</span><span class="s1">&#39;data/subset/220966 - 1.json&#39;</span><span class="p">,</span> <span class="n">predictions</span><span class="p">)</span>
      <span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
      <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;data/subset/220966 - 1.json&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfile</span><span class="p">:</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">outfile</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>   

    <span class="c1">## Unet Predict classes from a well image</span>
    <span class="k">def</span> <span class="nf">unet_predict_classes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="s1">&#39;data/subset/220967 - 1.json&#39;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">fn</span><span class="p">))</span>

        <span class="c1">## Infer Classes</span>

        <span class="n">img</span> <span class="o">=</span> <span class="n">open_image</span><span class="p">(</span><span class="s1">&#39;data/subset/220972 - 1.jpg&#39;</span><span class="p">)</span>

        <span class="n">img</span> <span class="o">=</span> <span class="n">padImage_t</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="n">tiles</span> <span class="o">=</span> <span class="n">cut_tiles_t</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>

        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tiles</span><span class="p">)</span>
        <span class="n">pred_class</span><span class="p">,</span> <span class="n">pred_idx</span><span class="p">,</span> <span class="n">outputs</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="n">n</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="n">n</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="n">n</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">im</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tiles</span><span class="p">):</span>
          <span class="n">pc</span><span class="p">,</span><span class="n">pi</span><span class="p">,</span><span class="n">o</span> <span class="o">=</span> <span class="n">learn</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>  
          <span class="n">pred_class</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pc</span><span class="o">.</span><span class="n">px</span>

        <span class="n">vstack</span> <span class="o">=</span> <span class="n">lay_tiles_t</span><span class="p">(</span><span class="n">pred_class</span><span class="p">,</span> <span class="n">TM</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">TN</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
        <span class="n">Image</span><span class="p">(</span><span class="n">vstack</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>

    <span class="c1">## Infer Probabilities</span>
    <span class="k">def</span> <span class="nf">unet_predict_eggs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">):</span>
      <span class="n">img</span> <span class="o">=</span> <span class="n">open_image</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>

      <span class="n">PAD</span> <span class="o">=</span> <span class="mi">100</span>
      <span class="n">TM</span><span class="p">,</span> <span class="n">TN</span> <span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span>
      <span class="n">img</span> <span class="o">=</span> <span class="n">padImage_t</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="n">PAD</span><span class="p">)</span>
      <span class="n">tiles</span> <span class="o">=</span> <span class="n">cut_tiles_t</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">TM</span><span class="o">=</span><span class="n">TM</span><span class="p">,</span> <span class="n">TN</span><span class="o">=</span><span class="n">TN</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="n">PAD</span><span class="p">)</span>

      <span class="n">outputs</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">im</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tiles</span><span class="p">):</span>
        <span class="n">pc</span><span class="p">,</span><span class="n">pi</span><span class="p">,</span><span class="n">o</span> <span class="o">=</span> <span class="n">learn</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>  
        <span class="n">outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>

      <span class="n">vstack</span> <span class="o">=</span> <span class="n">lay_tiles_t</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">TM</span><span class="o">=</span><span class="n">TM</span><span class="p">,</span> <span class="n">TN</span><span class="o">=</span><span class="n">TN</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="n">PAD</span><span class="p">)</span>
      <span class="n">vstack</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="n">vstack</span><span class="p">[</span><span class="mi">1</span><span class="p">,:,:]</span>
      <span class="n">vstack</span><span class="p">[</span><span class="mi">1</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="n">vstack</span><span class="p">[</span><span class="mi">2</span><span class="p">,:,:]</span>
      <span class="n">vstack</span><span class="p">[</span><span class="mi">2</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1">#   vstack[vstack&lt;0.3] = 0</span>
      <span class="n">img</span> <span class="o">=</span> <span class="n">to_np</span><span class="p">(</span><span class="n">vstack</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">img</span>


    <span class="c1">### Generate prediction png file</span>
    <span class="c1"># def predict_in_image(self, fn, CONF=0.3):</span>
    <span class="c1">#   pred_img = unet_predict_eggs(fn)</span>
    <span class="c1">#   predictions = mark_predictions(pred_img, CONF=CONF)</span>
    <span class="c1"># #   print(predictions)</span>
    <span class="c1">#   jdata= annotate_json(f&#39;{img_path}/{fn.stem}.json&#39;, predictions)</span>
    <span class="c1"># </span>
    <span class="c1">#   mrk_img = np.asarray(PIL.Image.open(fn))</span>
    <span class="c1">#   mrk_img = draw_labels_cv(mrk_img, jdata, radius=50)</span>
    <span class="c1">#   return pred_img, mrk_img, jdata</span>

    <span class="c1"># def markup_image(self, img, CONF=0.5):</span>
    <span class="c1">#     predictions, _ = self.find_prediction_blobs(img, CONF=CONF)</span>
    <span class="c1">#     #   print(predictions)</span>
    <span class="c1">#     jdata= self.annotate_json(f&#39;{self.img_path}/{fn.stem}.json&#39;, predictions)</span>
    <span class="c1"># </span>
    <span class="c1">#     mrk_img = np.asarray(PIL.Image.open(f&#39;{img_path}/{fn.stem}.jpg&#39;))</span>
    <span class="c1">#     mrk_img = self.draw_labels_cv(mrk_img, jdata, radius=50)</span>
    <span class="c1">#     return mrk_img, jdata</span>
    
    <span class="k">def</span> <span class="nf">markup_all_images_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">CONF</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
        <span class="n">fnames</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">get_files</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mrk_path</span><span class="p">,</span> <span class="s1">&#39;.png&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">count</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span> 
            <span class="n">fnames</span> <span class="o">=</span> <span class="n">fnames</span><span class="p">[:</span><span class="n">count</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Marking up {len(fnames)} images&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">fn</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fnames</span><span class="p">):</span>
<span class="c1">#             print(fn, end=&#39; &#39;)</span>
            <span class="n">src_img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">PIL</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fn</span><span class="p">))</span>
            <span class="c1"># find blobs in png            mrk_img, jdata = self.markup_image(img) </span>
            <span class="n">predictions</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_prediction_blobs</span><span class="p">(</span><span class="n">src_img</span><span class="p">,</span> <span class="n">CONF</span><span class="o">=</span><span class="n">CONF</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">predictions</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;, &#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">%</span> <span class="mi">20</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
              <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>
    
            <span class="c1"># annotate json</span>
            <span class="n">jdata</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotate_json</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{self.img_path}</span><span class="s1">/</span><span class="si">{fn.stem}</span><span class="s1">.json&#39;</span><span class="p">,</span> <span class="n">predictions</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{self.mrk_path}</span><span class="s1">/</span><span class="si">{fn.stem}</span><span class="s1">.json&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfile</span><span class="p">:</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">jdata</span><span class="p">,</span> <span class="n">outfile</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>   
            <span class="c1"># mark up jpg</span>
            <span class="n">mrk_img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">PIL</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{self.img_path}</span><span class="s1">/</span><span class="si">{fn.stem}</span><span class="s1">.jpg&#39;</span><span class="p">))</span>
            <span class="n">mrk_img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">draw_labels_cv</span><span class="p">(</span><span class="n">mrk_img</span><span class="p">,</span> <span class="n">jdata</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
            <span class="n">PIL</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">mrk_img</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">))</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{self.mrk_path}</span><span class="s1">/</span><span class="si">{fn.stem}</span><span class="s1">.jpg&#39;</span><span class="p">,</span> <span class="n">quality</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>  

        <span class="k">return</span> <span class="n">mrk_img</span>
    


    <span class="k">def</span> <span class="nf">calc_stats_row</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jdata</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mi">30</span><span class="p">):</span>
        <span class="n">human</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">machine</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">s</span><span class="p">,</span><span class="n">sh</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">jdata</span><span class="p">[</span><span class="s1">&#39;shapes&#39;</span><span class="p">]):</span>
            <span class="n">ave</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">sh</span><span class="p">[</span><span class="s2">&quot;points&quot;</span><span class="p">]),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">sh</span><span class="p">[</span><span class="s1">&#39;shape_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;rectangle&#39;</span><span class="p">:</span>
                <span class="n">human</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ave</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">sh</span><span class="p">[</span><span class="s1">&#39;shape_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;circle&#39;</span><span class="p">:</span>
                <span class="n">machine</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ave</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;unknown label&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;imagePath&quot;</span><span class="p">])</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">human</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">machine</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="n">distance</span><span class="o">.</span><span class="n">cdist</span><span class="p">(</span><span class="n">human</span><span class="p">,</span> <span class="n">machine</span><span class="p">,</span> <span class="s1">&#39;euclidean&#39;</span><span class="p">)</span>
            <span class="n">n_human</span><span class="p">,</span> <span class="n">n_AI</span><span class="p">,</span> <span class="n">n_match</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">human</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">machine</span><span class="p">),</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">dist</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">radius</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">n_human</span><span class="p">,</span> <span class="n">n_AI</span><span class="p">,</span> <span class="n">n_match</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">human</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">machine</span><span class="p">),</span> <span class="mi">0</span>

        <span class="n">row</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;File&#39;</span><span class="p">:</span> <span class="n">jdata</span><span class="p">[</span><span class="s2">&quot;imagePath&quot;</span><span class="p">],</span>
            <span class="s1">&#39;Num Human&#39;</span><span class="p">:</span> <span class="n">n_human</span><span class="p">,</span> 
            <span class="s1">&#39;Num AI&#39;</span><span class="p">:</span> <span class="n">n_AI</span><span class="p">,</span> 
            <span class="s1">&#39;Matched&#39;</span><span class="p">:</span> <span class="n">n_match</span><span class="p">,</span> 
            <span class="s1">&#39;AI: Un-matched&#39;</span><span class="p">:</span> <span class="n">n_AI</span> <span class="o">-</span> <span class="n">n_match</span><span class="p">,</span> 
            <span class="s1">&#39;AI: Missed Eggs&#39;</span><span class="p">:</span> <span class="n">n_human</span> <span class="o">-</span> <span class="n">n_match</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">row</span>

    <span class="k">def</span> <span class="nf">calc_stats_table</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># img_path = Path(&#39;data/markup&#39;)</span>
    <span class="c1">#     mrk_path = Path(&#39;data/testimages-markup/&#39;)</span>

        <span class="n">fnames</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">get_files</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mrk_path</span><span class="p">,</span> <span class="s1">&#39;.json&#39;</span><span class="p">))</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">DataFrame</span> <span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;File&#39;</span><span class="p">,</span> <span class="s1">&#39;Num Human&#39;</span><span class="p">,</span><span class="s1">&#39;Num AI&#39;</span><span class="p">,</span> <span class="s1">&#39;Matched&#39;</span><span class="p">,</span> <span class="s1">&#39;AI: Un-matched&#39;</span><span class="p">,</span> <span class="s1">&#39;AI: Missed Eggs&#39;</span><span class="p">])</span>
        <span class="n">fnames</span> <span class="o">=</span> <span class="n">fnames</span>
        <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">fnames</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">fn</span><span class="p">))</span>
            <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_stats_row</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)):</span>
            <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="n">col</span><span class="p">])</span>

        <span class="n">_sum</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">numeric_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;Total&#39;</span><span class="p">)</span> 
        <span class="n">_mean</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">numeric_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;Mean&#39;</span><span class="p">)</span> 

        <span class="c1"># df= df.append(df.sum(axis = 0, skipna=True, numeric_only=True).rename(&#39;Total&#39;)) </span>

        <span class="c1"># df=df.append(df.mean(axis = 0, skipna=True, numeric_only=True).rename(&#39;Mean&#39;))    </span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_mean</span><span class="p">)</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_sum</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span>
    <span class="k">def</span> <span class="nf">plot_piechart</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;gold&#39;</span><span class="p">,</span> <span class="s1">&#39;yellowgreen&#39;</span><span class="p">,</span> <span class="s1">&#39;lightcoral&#39;</span><span class="p">,</span> <span class="s1">&#39;lightskyblue&#39;</span><span class="p">]</span>
        <span class="n">explode</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># explode 1st slice</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="s1">&#39;Matched Eggs&#39;</span><span class="p">,</span> <span class="s1">&#39;AI: Missed Eggs&#39;</span> 
        <span class="n">sizes</span> <span class="o">=</span> <span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="s1">&#39;Total&#39;</span><span class="p">,</span><span class="s1">&#39;Matched&#39;</span><span class="p">],</span> <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="s1">&#39;Total&#39;</span><span class="p">,</span><span class="s1">&#39;AI: Missed Eggs&#39;</span><span class="p">]]</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">pie</span><span class="p">(</span><span class="n">sizes</span><span class="p">,</span> <span class="n">explode</span><span class="o">=</span><span class="n">explode</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span>
        <span class="n">autopct</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%1.1f%%</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">shadow</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">startangle</span><span class="o">=</span><span class="mi">140</span><span class="p">)</span>

        <span class="n">labels</span> <span class="o">=</span> <span class="s1">&#39;Matched Eggs&#39;</span><span class="p">,</span> <span class="s1">&#39;AI: Predictions not Matched&#39;</span> 
        <span class="n">sizes</span> <span class="o">=</span> <span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="s1">&#39;Total&#39;</span><span class="p">,</span><span class="s1">&#39;Matched&#39;</span><span class="p">],</span> <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="s1">&#39;Total&#39;</span><span class="p">,</span><span class="s1">&#39;AI: Un-matched&#39;</span><span class="p">]]</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">pie</span><span class="p">(</span><span class="n">sizes</span><span class="p">,</span> <span class="n">explode</span><span class="o">=</span><span class="n">explode</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span>
        <span class="n">autopct</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%1.1f%%</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">shadow</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">startangle</span><span class="o">=</span><span class="mi">140</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">pad</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
<span class="c1"># pi = AnalysePredictions()</span>
<span class="c1"># print(&quot;Start tests:&quot;)</span>
<span class="c1"># pi.test_annotate_json()</span>
<span class="c1"># ii.test_draw_labels_cv()</span>
<span class="c1"># ii.test_find_prediction_blobs()</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Run-Analysis">Run Analysis<a class="anchor-link" href="#Run-Analysis">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">find_prediction_blobs</span><span class="p">(</span> <span class="n">img</span><span class="p">,</span> <span class="n">CONF</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span> 
    <span class="c1"># region props seems to have region.max_intensity errors if no data not np.int </span>
    <span class="n">SCALE</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">CONF</span> <span class="o">*=</span> <span class="n">SCALE</span>
    
    <span class="n">img</span> <span class="o">=</span> <span class="p">(</span><span class="n">img</span> <span class="o">*</span> <span class="p">(</span><span class="n">SCALE</span><span class="o">/</span><span class="n">img</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
    <span class="n">img</span><span class="p">[</span><span class="n">img</span><span class="o">&lt;</span><span class="n">CONF</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">predictions</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">label_image</span> <span class="o">=</span> <span class="n">label</span><span class="p">(</span><span class="n">img</span> <span class="o">&gt;</span> <span class="n">CONF</span><span class="p">)</span>
    
    <span class="c1">#         img = np.array(img) # helped with a cv error?</span>
    <span class="k">for</span> <span class="n">region</span> <span class="ow">in</span> <span class="n">regionprops</span><span class="p">(</span><span class="n">label_image</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">region</span><span class="o">.</span><span class="n">area</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
            <span class="n">cx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">region</span><span class="o">.</span><span class="n">centroid</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">cy</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">region</span><span class="o">.</span><span class="n">centroid</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">predictions</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s1">&#39;Strongyle&#39;</span><span class="p">,</span> <span class="s2">&quot;point&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">cx</span><span class="p">,</span><span class="n">cy</span><span class="p">],</span> <span class="s2">&quot;probability&quot;</span><span class="p">:</span> <span class="n">region</span><span class="o">.</span><span class="n">max_intensity</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)})</span>  
    
    <span class="k">return</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">img</span>


<span class="k">def</span> <span class="nf">annotate_json</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">annotations</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="s1">&#39;Annotate the json file with predictions&#39;</span>
    <span class="k">def</span> <span class="nf">add_anno</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="n">r</span> <span class="o">=</span> <span class="mi">40</span>
        <span class="n">cx</span><span class="p">,</span><span class="n">cy</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;point&#39;</span><span class="p">]</span>
        <span class="n">pnt_list</span> <span class="o">=</span> <span class="p">[[</span><span class="n">cx</span><span class="o">-</span><span class="n">r</span><span class="p">,</span><span class="n">cy</span><span class="o">-</span><span class="n">r</span><span class="p">],</span> <span class="p">[</span><span class="n">cx</span><span class="o">+</span><span class="n">r</span><span class="p">,</span><span class="n">cy</span><span class="o">+</span><span class="n">r</span><span class="p">]]</span>

        <span class="n">probability</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;probability&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="s1">&#39;probability&#39;</span> <span class="ow">in</span> <span class="n">item</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">][:</span><span class="mi">3</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;Str&#39;</span><span class="p">:</span> 
            <span class="n">line_color</span> <span class="o">=</span> <span class="p">[</span><span class="mi">255</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">127</span><span class="p">]</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;shapes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">],</span><span class="s2">&quot;line_color&quot;</span><span class="p">:</span> <span class="n">line_color</span><span class="p">,</span> <span class="s2">&quot;fill_color&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="s2">&quot;points&quot;</span><span class="p">:</span> <span class="n">pnt_list</span><span class="p">,</span> <span class="s2">&quot;shape_type&quot;</span><span class="p">:</span> <span class="s2">&quot;circle&quot;</span><span class="p">,</span> <span class="s1">&#39;probability&#39;</span><span class="p">:</span> <span class="n">probability</span>
        <span class="p">})</span>      

        <span class="k">elif</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">][:</span><span class="mi">3</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;Nem&#39;</span><span class="p">:</span> 
            <span class="n">line_color</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">127</span><span class="p">]</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;shapes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">],</span><span class="s2">&quot;line_color&quot;</span><span class="p">:</span> <span class="n">line_color</span><span class="p">,</span> <span class="s2">&quot;fill_color&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="s2">&quot;points&quot;</span><span class="p">:</span> <span class="n">pnt_list</span><span class="p">,</span> <span class="s2">&quot;shape_type&quot;</span><span class="p">:</span> <span class="s2">&quot;circle&quot;</span><span class="p">,</span> <span class="s1">&#39;probability&#39;</span><span class="p">:</span> <span class="n">probability</span>
            <span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Unknown label&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_annotations</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">annotations</span><span class="p">):</span> 
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">annotations</span><span class="p">:</span>
            <span class="n">add_anno</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">del_circle_annotations</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
        <span class="n">to_del</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span><span class="n">sh</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;shapes&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="n">sh</span><span class="p">[</span><span class="s1">&#39;shape_type&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;circle&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">to_del</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> 
            <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Deleting {len(to_del)} circle annotations&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">to_del</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="k">del</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;shapes&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>        

    <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">fn</span><span class="p">))</span>
    <span class="c1"># del_circle_annotations(data)</span>
    <span class="n">add_annotations</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">annotations</span><span class="p">)</span> 
    <span class="k">return</span> <span class="n">data</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">preds</span>
<span class="n">predictions</span><span class="p">,</span> <span class="n">img</span> <span class="o">=</span> <span class="n">find_prediction_blobs</span><span class="p">(</span> <span class="n">to_np</span><span class="p">(</span><span class="n">preds</span><span class="p">[</span><span class="s1">&#39;Fluke_Liver&#39;</span><span class="p">]))</span>
<span class="n">show_img</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
<span class="n">predictions</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[{&#39;label&#39;: &#39;Strongyle&#39;, &#39;point&#39;: [768, 177], &#39;probability&#39;: 69},
 {&#39;label&#39;: &#39;Strongyle&#39;, &#39;point&#39;: [313, 336], &#39;probability&#39;: 100},
 {&#39;label&#39;: &#39;Strongyle&#39;, &#39;point&#39;: [288, 650], &#39;probability&#39;: 99},
 {&#39;label&#39;: &#39;Strongyle&#39;, &#39;point&#39;: [770, 685], &#39;probability&#39;: 83}]</pre>
</div>

</div>

<div class="output_area">



<div class="output_png output_subarea ">
<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAOwAAADnCAYAAAAdFLrXAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAALEgAACxIB0t1+/AAAADh0RVh0U29mdHdhcmUAbWF0cGxvdGxpYiB2ZXJzaW9uMy4xLjAsIGh0dHA6Ly9tYXRwbG90bGliLm9yZy+17YcXAAAFRUlEQVR4nO3aT4hVdRzG4e+duddRyRwdR+2PGlqBhEUY1MwmIow2LSJsEQjRyixo0y4ICdpFEIQE0SKkhbhoF4EtIkgtMAzDyjBKQco/NaZOzox6W1jtDMs7c3rH51nN3AOHd/Ph/LjntrrdbgEZ+poeAFw9wUIQwUIQwUIQwUKQ9j9d3NC30VfIMMN2XdrZutI1T1gIIlgIIlgIIlgIIlgIIlgIIlgIIlgIIlgIIlgIIlgIIlgIIlgIIlgIIlgIIlgIIlgIIlgIIlgIIlgIIlgIIlgIIlgIIlgIIlgIIlgIIlgIIlgIIlgIIlgIIlgIIlgIIlgIIlgIIlj+s59eGK0jW0ebnnFdaTc9gFzL39jd9ITrjicsBBEsBBEsBBEsBBEsBBEsBBEsBBEsBBEsBPFLJ5hGx7eM1uTCqv6Jqptev/ZfhgkWeuzE5pE6t6JqasVEDS0+WQs6U/Xz2II6+tJorXj12qIVLPTYb7d3q3/FeC278VzNbV+osxMDNTneqUWnutd8b8FCD41tGqnO2VadPz1QJy7018XTnWpN9dXQV60aenvPNd9fsNBDg9v31OCff5/YPFKdc5c/6xXBwjQZfqt3of7Fax0IIlgIIlgIIlgIIlgIIlgIIlgIIlgIIlgIIlgIIlgIIlgIIlgIIlgIIlgIIlgIIlgIIlgIIlgIIlgIIlgIIlgIIlgIIlgIIlgIIlgIIlgIIlgIIlgIIlgIIlgIIlgIIlgIIlgIIlgIIlgIIlgI0m56wPXkyNbROr9qolrn2nXH8581PYdAgp0hh9+7t94debNWt8drqqo23/VkXXzoWNOzCONIPEMevfNg3TNnspb0z6vFfe16YvkXTU8ikGBnwNimkfplcv7f/w+0OnVg/NYGF5FKsDNgcPue2v/B2tpx5rY6efH3+nyiVV+vv9D0LAK1ut3uFS9u6Nt45Yv8a4dfe6BaN5+v1U/tb3oK/2O7Lu1sXemaL51m0JoX9zY9gXCOxBBEsBBEsBBEsBBEsBBEsBBEsBBEsBBEsBBEsBBEsBBEsBBEsBBEsBBEsBBEsBBEsBBEsBBEsBBEsBBEsBBEsBBEsBBEsBBEsBBEsBBEsBBEsBBEsBBEsBBEsBBEsBBEsBBEsBBEsBBEsBBEsBBEsBBEsBBEsBBEsBBEsBBEsBBEsBBEsBBEsBBEsBBEsBBEsBBEsBBEsBBEsBBEsBBEsBBEsBBEsBBEsBBEsBBEsBBEsBBEsBBEsBBEsBBEsBBEsBBEsBBEsBBEsBBEsBBEsBBEsBBEsBBEsBBEsBBEsBBEsBBEsBBEsBBEsBBEsD105OXRGvp0UT333aF6/OCJmty1qo5vGW16FrNIu+kBs8nDj+2rZ4c/rlXtVp0ZOF7r1hytZx58umpb08uYLTxhe+T4ltF6ZPBArWq3aqDVqSX982p1e7w6nYtNT2MWEWyPLN22u94/tb6+neqrie5Unb00UV9ODlXno4VNT2MWcSTuob0frqtv7l9at9xwur7/dagu7RqqZdt2Nz2LWUSwPbRy6+U4z1TVcJ1sdgyzkiMxBBEsBBEsBBEsBBEsBBEsTJND79xXa/e164cdd9fYppGe3NNrHZgmc3+cU58Mr6kLx+bX4PY9PbmnYGGarHzl8nv54R7e05EYgggWgggWgggWgggWgggWgggWgggWgggWgggWgggWgggWgggWgggWgggWgggWgggWgggWgggWgggWgggWgggWgggWgggWgggWgggWgggWgggWgggWgrS63W7TG4Cr5AkLQQQLQQQLQQQLQQQLQQQLQf4A0/ir67G8p2EAAAAASUVORK5CYII=
"
>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">to_np</span><span class="p">(</span><span class="n">preds</span><span class="p">[</span><span class="s1">&#39;Fluke_Liver&#39;</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>array([[2.530080e-03, 2.290793e-03, 9.769002e-04, 2.425112e-04, ..., 2.832348e-03, 4.224682e-03, 4.696379e-03,
        8.341388e-03],
       [7.502590e-04, 8.338390e-04, 7.248910e-04, 1.502040e-04, ..., 2.461558e-03, 4.082000e-03, 4.715894e-03,
        6.574791e-03],
       [3.527227e-04, 3.848545e-04, 6.420778e-04, 1.822658e-04, ..., 2.942182e-03, 5.112409e-03, 4.840271e-03,
        2.247877e-03],
       [2.976774e-04, 3.085131e-04, 5.771366e-04, 2.293458e-04, ..., 1.864430e-03, 3.432195e-03, 2.624897e-03,
        7.026473e-04],
       ...,
       [1.984489e-03, 2.766282e-03, 1.858092e-03, 5.149026e-04, ..., 2.815052e-07, 9.348914e-07, 2.402427e-06,
        2.821103e-06],
       [3.302467e-03, 3.153032e-03, 2.695337e-03, 1.164194e-03, ..., 3.090470e-06, 7.436967e-06, 1.892944e-05,
        2.077264e-05],
       [1.551290e-03, 7.544339e-04, 1.294823e-03, 6.098641e-04, ..., 5.507753e-06, 1.009877e-05, 1.959550e-05,
        5.298379e-05],
       [1.568920e-03, 7.218754e-04, 1.271034e-03, 7.781513e-04, ..., 1.883820e-05, 2.519766e-05, 8.562210e-05,
        5.039946e-04]], dtype=float32)</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">img_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">dirs</span><span class="o">.</span><span class="n">train</span><span class="p">)</span>
<span class="n">mrk_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;../testdata_2/Fullsize/markup&#39;</span><span class="p">)</span>  
<span class="n">mrk_path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">fnames</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">get_image_files</span><span class="p">(</span><span class="n">img_path</span><span class="p">))</span>
<span class="n">classes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Background&#39;</span><span class="p">,</span> <span class="s1">&#39;Fluke_Liver&#39;</span><span class="p">,</span> <span class="s1">&#39;Fluke_Rumen&#39;</span><span class="p">,</span> <span class="s1">&#39;Other&#39;</span><span class="p">]</span>

<span class="n">preds</span> <span class="o">=</span> <span class="n">run_prediction</span><span class="p">(</span><span class="n">learn</span><span class="p">,</span> <span class="n">fnames</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">classes</span><span class="o">=</span><span class="n">classes</span><span class="p">,</span> <span class="n">tile</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">filesavedir</span><span class="o">=</span><span class="n">mrk_path</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Background torch.Size([800, 816])
Fluke_Liver torch.Size([800, 816])
Fluke_Rumen torch.Size([800, 816])
Other torch.Size([800, 816])
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">save_png</span><span class="p">(</span><span class="n">img</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">cmap</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s1">&#39;hot&#39;</span><span class="p">):</span>
    <span class="c1"># img = PIL.Image.fromarray(to_np(img*255).astype(np.uint8))</span>
    <span class="c1"># img = img.convert(&#39;P&#39;, palette=PIL.Image.ADAPTIVE, colors=256)</span>
    <span class="c1"># img.save(fn)</span>
    <span class="c1"># Get the color map by name:</span>
    <span class="n">cm</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">cmap</span><span class="p">)</span>
    <span class="n">colored_image</span> <span class="o">=</span> <span class="n">cm</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
    <span class="n">PIL</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">((</span><span class="n">colored_image</span> <span class="o">*</span> <span class="mi">255</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">))</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>   

<span class="k">def</span> <span class="nf">save_png_p</span><span class="p">(</span><span class="n">img</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">cmap</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s1">&#39;hot&#39;</span><span class="p">,</span> <span class="n">num_colors</span><span class="o">=</span><span class="mi">256</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">num_colors</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">num_colors</span> <span class="o">&lt;=</span> <span class="mi">256</span><span class="p">,</span> <span class="s1">&#39;num_colors must be in range 0 to 256&#39;</span>
    <span class="n">cm</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">cmap</span><span class="p">)</span>
    <span class="n">palette</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">256</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span><span class="o">*</span><span class="mi">128</span>
    <span class="n">pal</span> <span class="o">=</span> <span class="p">(</span><span class="n">cm</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_colors</span><span class="p">))</span><span class="o">*</span><span class="mi">255</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)[:,:</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">palette</span><span class="p">[:</span><span class="n">num_colors</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">pal</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">PIL</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">((</span><span class="n">img</span><span class="o">*</span><span class="mi">255</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">),</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;P&#39;</span><span class="p">)</span>
    <span class="n">img</span><span class="o">.</span><span class="n">putpalette</span><span class="p">(</span><span class="n">palette</span><span class="p">)</span>
    <span class="n">img</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>

<span class="n">raw_pred</span>  <span class="o">=</span> <span class="n">to_np</span><span class="p">(</span><span class="n">preds</span><span class="p">[</span><span class="s1">&#39;Fluke_Liver&#39;</span><span class="p">])</span>
<span class="n">save_png_p</span><span class="p">(</span><span class="n">raw_pred</span><span class="p">,</span> <span class="n">f</span><span class="s1">&#39;</span><span class="si">{mrk_path}</span><span class="s1">/{&quot;111test&quot;}.png&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;tab10&#39;</span><span class="p">,</span> <span class="n">num_colors</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">save_png_p</span><span class="p">(</span><span class="n">raw_pred</span><span class="p">,</span> <span class="n">f</span><span class="s1">&#39;</span><span class="si">{mrk_path}</span><span class="s1">/{&quot;112test&quot;}.png&#39;</span><span class="p">)</span>
<span class="n">save_png_p</span><span class="p">(</span><span class="n">raw_pred</span><span class="p">,</span> <span class="n">f</span><span class="s1">&#39;</span><span class="si">{mrk_path}</span><span class="s1">/{&quot;113test&quot;}.png&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Dark2&#39;</span><span class="p">,</span> <span class="n">num_colors</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">palette</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span>
<span class="n">cm</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;hot&#39;</span><span class="p">)</span>
<span class="n">palette</span> <span class="o">=</span> <span class="p">(</span><span class="n">cm</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">256</span><span class="p">))</span><span class="o">*</span><span class="mi">255</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)[:,:</span><span class="mi">3</span><span class="p">]</span>
<span class="n">palette</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><a href="https://matplotlib.org/2.0.1/examples/color/colormaps_reference.html">colormaps</a></p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#</span>
<span class="n">raw_pred</span>  <span class="o">=</span> <span class="n">preds</span><span class="p">[</span><span class="s1">&#39;Fluke_Liver&#39;</span><span class="p">]</span>
<span class="n">save_png</span><span class="p">(</span><span class="n">raw_pred</span><span class="p">,</span> <span class="n">f</span><span class="s1">&#39;</span><span class="si">{mrk_path}</span><span class="s1">/{&quot;111test&quot;}.png&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>_pred  = preds['Fluke_Liver']
import matplotlib.pyplot as plt
lbl_pil = PIL.Image.fromarray(to_np(raw_pred*255).astype(np.uint8))
lbl_pil = lbl_pil.convert('P', palette=PIL.Image.ADAPTIVE, colors=256)
lbl_pil.save(f'{mrk_path}/{"111"}.png')
# Get the color map by name:
cm = plt.get_cmap('hot')

# Apply the colormap like a function to any array:
colored_image = cm(to_np(raw_pred))

# Obtain a 4-channel image (R,G,B,A) in float [0, 1]
# But we want to convert to RGB in uint8 and save it:
PIL.Image.fromarray((colored_image * 255).astype(np.uint8)).save(f'{mrk_path}/{"111test"}.png')
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">mrk_path</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">seq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span>
<span class="n">cm</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;hot&#39;</span><span class="p">)</span>
<span class="n">AAcolored_image</span> <span class="o">=</span> <span class="n">cm</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">palette</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="n">cm</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;tab10&#39;</span><span class="p">)</span>
<span class="n">palette</span> <span class="o">=</span> <span class="p">(</span><span class="n">cm</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span><span class="o">*</span><span class="mi">255</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)[:,:</span><span class="mi">3</span><span class="p">]</span>
<span class="n">palette</span>
</pre></div>

    </div>
</div>
</div>

</div>
</div>
 

